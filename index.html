<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbxZD0Bfb_1R3nVS5bedAUZX6P5qrI5-jF2u3NiCPsYG31WETPGtPWvKYJtHMtRMiuGMwg/exec";
  let allProducts = [];
  let cart = {};

  async function loadProducts() {
    try {
      const response = await fetch(scriptURL);
      const data = await response.json();
      allProducts = data;
      renderProducts(allProducts);
      fillCategories(data);
    } catch (error) {
      console.error("Error al cargar los productos:", error);
    }
  }

  function renderProducts(products) {
    const table = document.getElementById("productTable");
    table.innerHTML = "";
    products.forEach(p => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-4 py-2">${p.id}</td>
        <td class="px-4 py-2">${p.nombre}</td>
        <td class="px-4 py-2">${p.categoria || ""}</td>
        <td class="px-4 py-2 text-center">${p.stock || 0}</td>
        <td class="px-4 py-2 text-center">
          <input type="number" min="0" value="0"
            class="border rounded px-2 py-1 w-16 text-center"
            onchange="updateCart('${p.id}', this.value, '${p.nombre}')">
        </td>
        <td class="px-4 py-2 text-center">
          <button class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700"
            onclick="addToCart('${p.id}', '${p.nombre}')">Agregar</button>
        </td>
      `;
      table.appendChild(row);
    });
  }

  function fillCategories(data) {
    const categories = [...new Set(data.map(p => p.categoria).filter(Boolean))];
    const select = document.getElementById("categoryFilter");
    categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    });
  }

  function filterProducts() {
    const search = document.getElementById("searchInput").value.toLowerCase();
    const category = document.getElementById("categoryFilter").value;
    const filtered = allProducts.filter(p =>
      (!category || p.categoria === category) &&
      (!search || p.nombre.toLowerCase().includes(search))
    );
    renderProducts(filtered);
  }

  function updateCart(id, qty, name) {
    qty = parseInt(qty);
    if (qty > 0) cart[id] = { name, qty };
    else delete cart[id];
    renderSummary();
  }

  function addToCart(id, name) {
    if (!cart[id]) cart[id] = { name, qty: 1 };
    else cart[id].qty++;
    renderSummary();
  }

  function renderSummary() {
    const table = document.getElementById("summaryTable");
    table.innerHTML = "";
    Object.entries(cart).forEach(([id, item]) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-4 py-2">${item.name}</td>
        <td class="px-4 py-2 text-center">${item.qty}</td>
        <td class="px-4 py-2 text-center">
          <button class="bg-red-500 text-white px-2 py-1 rounded"
            onclick="removeFromCart('${id}')">X</button>
        </td>
      `;
      table.appendChild(row);
    });
  }

  function removeFromCart(id) {
    delete cart[id];
    renderSummary();
  }

  // === NUEVA FUNCIÓN: Enviar al Apps Script ===
  document.getElementById("submitOrder").addEventListener("click", async () => {
    const name = document.getElementById("userName").value.trim();
    if (!name) return alert("Por favor, escribe tu nombre.");
    if (Object.keys(cart).length === 0) return alert("No has agregado productos.");

    const order = {
      nombre: name,
      pedido: Object.entries(cart).map(([id, item]) => ({
        id,
        nombre: item.name,
        cantidad: item.qty
      }))
    };

    try {
      const response = await fetch(scriptURL, {
        method: "POST",
        mode: "no-cors", // importante para Apps Script
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(order)
      });

      alert("✅ Pedido enviado correctamente");
      cart = {};
      renderSummary();
    } catch (err) {
      console.error(err);
      alert("Hubo un error al enviar el pedido.");
    }
  });

  document.getElementById("searchInput").addEventListener("input", filterProducts);
  document.getElementById("categoryFilter").addEventListener("change", filterProducts);

  loadProducts();
</script>
